<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta
            name="viewport"
            content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>ì±—ë°©</title>
    <link rel="stylesheet" href="/static/common.css" />
    <link rel="stylesheet" href="/static/chat.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"
            integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <link rel="stylesheet" href="/static/scroll.css">
    <link rel="stylesheet" href="/static/extra.css">

    <style>


    </style>
</head>
<body>
<div id="root">
    <div id="chatWrap">
        <div id="chatHeader">
            <button id="back">
                <a href="/">
                    <i class="fas fa-times"></i>
                </a>
            </button>
            <span>ë©¤ë²„ : </span>
            <h1 class="member">
                Chat</h1>
            <!--      <button id="more">-->
            <!--        <i class="fas fa-bars"></i>-->
            <!--      </button>-->
        </div>
        <div id="chatContent" class="container">
            <div class="chat-wrap ur-chat-wrap">
                <p class="nick">ë°©ì¥ë´‡</p>
                <div class="message chat-box ur-chat" id="test1"><span class="text">ì•ˆë…•í•˜ì„¸ìš”. </span></div>
                <div class="button-bar off ur-button-bar flex-off">
                    <button class="btn-item quake" id="quake">ğŸŒ€</button>
                    <button class="btn-item ta-da" id="tada">ğŸ‰</button>
                    <button class="btn-item">ğŸ’“</button>
                    <button class="btn-item">ğŸŒ€</button>
                    <button class="btn-item">ğŸŒ€</button>
                </div>
            </div>
            <div class="chat-wrap ur-chat-wrap">
                <p class="nick">ë°©ì¥ë´‡</p>
                <div class="message chat-box ur-chat" id="test2"><span class="text ">1.ë„ë°° ê¸ˆì§€ </span></div>
                <div class="button-bar off ur-button-bar flex-off">
                    <button class="btn-item quake" id="quake">ğŸŒ€</button>
                    <button class="btn-item ta-da" id="tada">ğŸ‰</button>
                    <button class="btn-item">ğŸ’“</button>
                    <button class="btn-item">ğŸŒ€</button>
                    <button class="btn-item">ğŸŒ€</button>
                </div>
            </div>
            <div class="chat-wrap ur-chat-wrap">
                <p class="nick">ë°©ì¥ë´‡</p>
                <div class="message chat-box ur-chat" id="test3"><span class="text">2.ì˜ì–´ ê¸ˆì§€</span></div>
                <div class="button-bar off ur-button-bar flex-off">
                    <button class="btn-item quake" id="quake">ğŸŒ€</button>
                    <button class="btn-item ta-da" id="tada">ğŸ‰</button>
                    <button class="btn-item">ğŸ’“</button>
                    <button class="btn-item">ğŸŒ€</button>
                    <button class="btn-item">ğŸŒ€</button>
                </div>
            </div>
        </div>
        <div id="chatFunc">
            <!--            <label for="whisper">-->
            <!--                <select name="select" id="whisper">-->
            <!--                    <option value="ê·“ì†ë§" selected>ê·“ì†ë§</option>-->
            <!--                </select>-->
            <!--            </label>-->
            <input
                    type="text"
                    id="type"
                    name="type"
                    placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥ í•˜ì„¸ìš”."
                    onfocus="this.placeholder=''"
                    onblur="this.placeholder='ë©”ì‹œì§€ë¥¼ ì…ë ¥ í•˜ì„¸ìš”.'"
            />
            <button id="enter">ì „ì†¡</button>
        </div>
    </div>
</div>
<!--<div class="entry">-->
<!--    <div class="box">-->
<!--        <input type="text" id="nickname" placeholder="Nickname" autofocus />-->
<!--        <button type="button" onclick="entry();">ì…ì¥</button>-->
<!--    </div>-->
<!--</div>-->

<script>
  //e.target ** í´ë¦­ã…
  // socket io ì—°ê²°
  let socket = io.connect();
  let myNick = '<%= name %>';
  const chat = document.querySelector("#chatContent");
  const urChat = document.querySelector('.ur-chat');
  const type = document.querySelector("#type");
  const enter = document.querySelector("#enter");
  reaction()

  // ë§í’ì„  í˜¸ë²„í•   ë•Œ ë°˜ì‘ íŒì—… on/off
  function reaction () {
    let msg = document.querySelectorAll(".message");
    // ë§ˆìš°ìŠ¤ í˜¸ë²„/ì•„ì›ƒì´ ë²„íŠ¼ë°” íŒì—…
    let chatWrap = document.querySelectorAll(".chat-wrap");
    msg.forEach((item) => {
      // console.log(item);
      item.addEventListener("mouseenter", function (e) {
        // console.log(this);
        e.stopPropagation();
        const btnBar = this.parentNode.querySelector(".button-bar");
        // console.log(btnBar)
        // const btnBar = this.querySelector(".button-bar");
        btnBar.classList.replace("off", "on");
      });
    });
    chatWrap.forEach((item) => {
      item.addEventListener("mouseleave", function (e) {
        e.stopPropagation();
        const btnBar = this.querySelector(".button-bar");
        btnBar.classList.replace("on", "off");
      });
    });
  }

  // ë°˜ì‘ ê´€ë ¨ ì½”ë“œ

  //
  //

  // const enter = document.querySelector("#enter");
  // const urName = urChat.before;
  // // ëŒ€í™” ìƒëŒ€ ì´ë¦„ ì„œë²„ì—ì„œ ê°€ì ¸ì˜¤ê¸°
  // function getUserName () {
  //   return 'asd'
  // }
  // // ëŒ€í™” ìƒëŒ€ ì´ë¦„ ì„¤ì •
  // urName.style.content = getUserName();
  //
  // ë©”ì‹œì§€ ì „ì†¡ì‹œ í™”ë©´ ì¶œë ¥

  // todo send ì´í›„ newMessage ì´ë²¤íŠ¸ë¡œ ìƒˆë¡œ ì—°ê²°
  const addMessage = (e) => {
    if (e.keyCode === 13 || e.type === "click") {
      if (!type.value) {
        alert("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”");
        return;
      } else {
        // io ìˆ˜ì‹  socket.on send
        const data = {
          nick:myNick,
          msg:type.value,
          sid:Date.now(),
        }
        socket.emit('send', data) // ë°ì´í„° ì„œë²„ë¡œ ë³´ëƒ„
        type.value = "";

      }
    }
  };
  enter.addEventListener("click", addMessage);
  type.addEventListener("keydown", addMessage);

  //todo  ë°›ì€ ë°ì´í„°ë¥¼ ë§í’ì„ ìœ¼ë¡œ ê¾¸ë©°ì„œ í™”ë©´ ì¶œë ¥í•˜ê¸°
  //todo  sid idê°’ìœ¼ë¡œ ì§€ì •í•´ì£¼ê¸°
  //todo  ìƒëŒ€ ë‹‰ë„¤ì„ì´ë©´ ur-chat / ur-button-bar
  //
  // const type = document.querySelector("#type");
  // const div = document.createElement("div");
  // const span = document.createElement("span");
  // div.classList.add("my-chat-wrap");
  // span.textContent = type.value;
  // span.classList.add("chat-box");
  // span.classList.add("my-chat");
  // div.appendChild(span);
  // chat.appendChild(div);


  //


</script>

<script>
  //<div class="button-bar off my-button-bar on">
  //         <button class="btn-item quake" id="quake">ğŸŒ€</button>
  //         <button class="btn-item ta-da" id="tada">ğŸ‰</button>
  //         <button class="btn-item">ğŸ’“</button>
  //         <button class="btn-item">ğŸŒ€</button>
  //         <button class="btn-item">ğŸŒ€</button>
  //       </div>
  const defaultReact = 'animate__animated';
  const reactObj = {
    quake:'animate__shakeX',
    tada:'animate__tada',
    heartBeat:'animate__heartBeat',
    rubber:'animate__rubberBand',
    hinge:'animate__hinge',
  };

  function makeBtnBar (who) {
    const buttonBar = document.createElement('div');
    buttonBar.classList.add('button-bar', who)
    buttonBar.classList.add('off')
    const button1 = document.createElement('button');
    button1.classList.add('btn-item', 'quake');
    button1.id = 'quake';
    button1.textContent = 'ğŸŒ€';
    buttonBar.appendChild(button1);
    const button2 = document.createElement('button');
    button2.classList.add('btn-item', 'ta-da');
    button2.id = 'tada';
    button2.textContent = 'ğŸ‰';
    buttonBar.appendChild(button2);
    const button3 = document.createElement('button');
    button3.classList.add('btn-item', 'heartbeat');
    button3.id = 'heartBeat'
    button3.textContent = 'ğŸ’“';
    buttonBar.appendChild(button3);
    const button4 = document.createElement('button');
    button4.classList.add('btn-item', 'rubber');
    button4.id = 'rubber'
    button4.textContent = 'ğŸ¦†';
    buttonBar.appendChild(button4);
    const button5 = document.createElement('button');
    button5.classList.add('btn-item', 'hinge');
    button5.id = 'hinge'
    button5.textContent = 'ğŸ”¨';
    buttonBar.appendChild(button5);

    return buttonBar;
  }
</script>
<script>
  socket.on('connect', (d) => {
    console.log(d)
    console.log('chat.ejs Connected =.', socket.id)
    socket.emit('entryChat');
  });
  socket.on('updateNicks', (nickObj) => {
    const h1 = document.querySelector('.member');
    const nickValues = Object.values(nickObj);
    h1.textContent = nickValues.join(',');
    //
  })
  socket.on('notice', (msg) => {
    document
    .querySelector("#chatContent")
    .insertAdjacentHTML("beforeend", `<div class="notice">${ msg }</div>`);
    setTimeout(() => {
      chat.scrollTop = chat.scrollHeight;
    }, 10)
  });


  function entry () {
    console.log(document.querySelector("#nickname").value);
    socket.emit("setNick", document.querySelector("#nickname").value);
  }

  // socket.on("entry", (nick) => {
  //   // 1. ë‚´ ë‹‰ë„¤ì„ ì„¤ì •
  //   myNick = nick;
  //   document.querySelector('.entry').remove();
  // // 2. ë‹‰ë„¤ì„ ì…ë ¥ì°½ & ë²„íŠ¼ ë¹„í™œì„±í™”
  // document.querySelector("#nickname").disabled = true; // ì…ë ¥ì°½ ë¹„í™œì„±í™” (í´ë¦­ ë§‰ê¸°)
  // document.querySelector(".entry-box > button").disabled = true; // ë²„íŠ¼ ë¹„í™œì„±í™” (í´ë¦­ ë§‰ê¸°)
  // // 3. div.chat-box ìš”ì†Œ ë³´ì´ê¸°
  // document.querySelector(".chat-box").classList.remove("d-none");
  // });
  socket.on('newMessage', (data) => {
    console.log('newMessage', data);
    //{nick: "test", msg: "rkddkwl", sid: "rid1681525512893"};
    const nick = document.createElement('p');
    nick.classList.add('nick');
    const text = document.createElement('span');
    text.classList.add('text');
    text.textContent = data.msg;
    const message = document.createElement('div');
    message.classList.add('chat-box', 'message');
    message.id = data.sid;
    const chatWrap = document.createElement('div');
    chatWrap.classList.add('chat-wrap');
    message.append(text);
    chatWrap.append(nick);
    chatWrap.append(message);
    if (data.nick === myNick) {
      message.classList.add('my-chat');
      // ë‹‰ë„¤ì„ ì„¤ì •
      nick.textContent = myNick;
      chatWrap.classList.add('my-chat-wrap');
      chatWrap.append(makeBtnBar('my-button-bar'));
      //<div class="chat-wrap my-chat-wrap">
      // <div class="message chat-box my-chat">
      // <span class="text">í…ŒìŠ¤íŠ¸ ì…ë‹ˆë‹¤.</span></div>
      // ìˆ˜ì‹ ëœ ë©”ì‹œì§€ê°€ ë‚´ ë‹‰ë„¤ì„ ê³¼ ê°™ìœ¼ë©´
      //ì±„íŒ…ì°½ì— ë„£ê¸°
    } else {
      // ì•„ë‹ ê²½ìš°
      message.classList.add('ur-chat');
      // ë‹‰ë„¤ì„  ì„¤ì •
      nick.textContent = data.nick;
      // const urChat = document.querySelector('.ur-chat');
      // const urChatAfter = window.getComputedStyle(urChat, '::after');
      // urChat.style.setProperty('--urNick', data.nick);
      chatWrap.classList.add('ur-chat-wrap');
      chatWrap.append(makeBtnBar('ur-button-bar'));
    }
    document.querySelector('#chatContent').append(chatWrap);
    chat.scrollTop = chat.scrollHeight;
    reaction();
    sendReact();

// ìƒì„±í•´ì•¼í•  ì±„íŒ… êµ¬ì¡°
//     <div class="chat-wrap my-chat-wrap">
//       <div class="msg chat-box my-chat"><span class="text">í…ŒìŠ¤íŠ¸ ì…ë‹ˆë‹¤1.</span></div>
//
//     </div>
//     ë©”ì„¸ì§€ê°€ ë„ì°©í–ˆìœ¼ë©´ nickname after ìš”ì†Œì•  ë„ìš°ê¸°
// myNick ì— ì €ì¥ëœ í˜„ì¬ ë‹‰ë„¤ì„ì´ ë‚´ê±°ë‘ ë‹¤ë¥´ë©´ ìƒëŒ€ë°©
    //
    // data ì˜ ë‹‰ë„¤ì„ì´ ê°™ë‹¤ë©´, ë‚´ ì±„íŒ…ìœ¼ë¡œ ë³´ì´ê²Œ (ì˜¤ë¥¸ìª½ ë°°ì¹˜ == .my-chat)
    // data ì˜ ë‹‰ë„¤ì„ì´ ë‹¤ë¥´ë‹¤ë©´, ìƒëŒ€ë°© ì±„íŒ…ìœ¼ë¡œ ë³´ì´ê²Œ (ì™¼ìª½ ë°°ì¹˜ == .other-chat)
    // divChatì˜ textContent/innerText ê°’ì„ ì ì§ˆíˆ ë³€ê²½
    // ex. nick : msg í˜•íƒœë¡œ ë³´ì´ê²Œ í–ˆìŒ
    // divChat ì„ div ìš”ì†Œì— ì¶”ê°€
    // divë¥¼ chatList ì— ì¶”ê°€
    // divChat.innerText = `${data.nick}: ${data.msg}`;
    // if (data.nick === myNick) {
    //   div.classList.add("my-chat");
    // } else {
    //   div.classList.add("other-chat");
    // }
    // div.append(divChat);
    // chatList.append(div);
  })
  // ì±„íŒ…ë°©
  // socket.emit('setNick', document.querySelector('#nickname').value)


  // ë¦¬ì•¡ì…˜ ë°˜ì‘
  // 4ê°œ ì¶”ê°€í•˜ê¸°

  function sendReact () {
    // todo: targetì˜ idê°’ì„ ì†¡ì‹  ë°›ì€ id ê°’ì„ ì¿¼ë¦¬ì…€ë ‰íŠ¸ í•˜ì—¬ í´ë˜ìŠ¤ ë¶€ì—¬
    const quake = document.querySelectorAll('.quake');
    const tada = document.querySelectorAll('.ta-da');
    const heartBeat = document.querySelectorAll('.heartbeat');
    const rubber = document.querySelectorAll('.rubber');
    const hinge = document.querySelectorAll('.hinge');

    quake.forEach((item) => {
      item.addEventListener('click', function (e) {
        const id = e.target.id;
        const reactID = reactObj[id];
        const target = this.parentNode.parentNode.querySelector('.chat-box')
        console.log(target)
        // íƒœê·¸ì˜ ê³ ìœ ê°’ ë³´ë‚´ê¸°
        const data = {
          reactID:reactID,
          id:id,
          rid:target.id,
          nick:this.parentNode.parentNode.querySelector('.nick').textContent
        }
        socket.emit('quake', data);
      })
    })
    quake.forEach((item) => {
      item.addEventListener('click', function (e) {
        const id = e.target.id;
        const reactID = reactObj[id];
        const target = this.parentNode.parentNode.querySelector('.chat-box')

        console.log(target)
        // íƒœê·¸ì˜ ê³ ìœ ê°’ ë³´ë‚´ê¸°
        const data = {
          reactID:reactID,
          id:id,
          rid:target.id,
          nick:this.parentNode.parentNode.querySelector('.nick').textContent
        }
        socket.emit('quake', data);
      })
    })
    tada.forEach((item) => {
      item.addEventListener('click', function (e) {
        const id = e.target.id;
        const reactID = reactObj[id];

        const target = this.parentNode.parentNode.querySelector('.chat-box')
        console.log(target)
        // íƒœê·¸ì˜ ê³ ìœ ê°’ ë³´ë‚´ê¸°
        const data = {
          reactID:reactID,
          id:id,
          rid:target.id,
          nick:this.parentNode.parentNode.querySelector('.nick').textContent
        }
        socket.emit('tada', data);
      })
    })
    heartBeat.forEach((item) => {
      item.addEventListener('click', function (e) {
        const id = e.target.id;
        const reactID = reactObj[id];

        const target = this.parentNode.parentNode.querySelector('.chat-box')
        console.log(target)
        // íƒœê·¸ì˜ ê³ ìœ ê°’ ë³´ë‚´ê¸°
        const data = {
          reactID:reactID,
          id:id,
          rid:target.id,
          nick:this.parentNode.parentNode.querySelector('.nick').textContent
        }
        socket.emit('heartBeat', data);
      })
    })
    rubber.forEach((item) => {
      item.addEventListener('click', function (e) {
        const id = e.target.id;
        const reactID = reactObj[id];

        const target = this.parentNode.parentNode.querySelector('.chat-box')
        console.log(target)
        // íƒœê·¸ì˜ ê³ ìœ ê°’ ë³´ë‚´ê¸°
        const data = {
          reactID:reactID,
          id:id,
          rid:target.id,
          nick:this.parentNode.parentNode.querySelector('.nick').textContent
        }
        socket.emit('rubber', data);
      })
    })
    hinge.forEach((item) => {
      item.addEventListener('click', function (e) {
        const id = e.target.id;
        const reactID = reactObj[id];

        const target = this.parentNode.parentNode.querySelector('.chat-box')
        console.log(target)
        // íƒœê·¸ì˜ ê³ ìœ ê°’ ë³´ë‚´ê¸°
        const data = {
          reactID:reactID,
          id:id,
          rid:target.id,
          nick:this.parentNode.parentNode.querySelector('.nick').textContent
        }
        socket.emit('hinge', data);
      })
    })
  }

  let proceeding = false;
  socket.on('react', (data) => {
    console.log('>>',data)

    const chatBox = document.querySelector('#' + data.id);
    // if (proceeding) return clearTimeout(removeReact);
    // const removeReact = setTimeout(function () {
    //   chatBox.classList.remove(data.second)
    //   proceeding = false;
    //   console.log(proceeding)
    // }, 1000)
    // if (chatBox.contains(data.second)) return;
    // chatBox.classList.remove(data.second);
    console.log('>>', data.first);
    // if (chatBox.contains(data.first)) chatBox.classList.toggle(data.first);

    if (chatBox.classList.contains('my-chat')) {
    chatBox.setAttribute('class', "chat-box message my-chat");
    } else {
      chatBox.setAttribute('class', "chat-box message ur-chat");
    }
    chatBox.classList.add(defaultReact, data.first);
    setTimeout(() => {
      chatBox.classList.remove(data.first);
    }, 1000)

    proceeding = true;
    // console.log(proceeding)
    // console.logs('react', data);
    // // {first: "animate__animated", second: "animate__shakeX", id: "rid1681528121811"}
    // console.log('selected chatbox', chatBox);
    // chatBox.removeAttribute('id');

    // ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
    // ë°›ì€ ID ì‚­ì œ
  })
</script>


<script>
  //   // todo í…ŒìŠ¤íŠ¸ 1í˜ì´ì§€ì—ì„œ ë„˜ê¸´ë°ì´í„° 2í˜ì´ì§€ í™•ì¸
  // socket.on('receiveTest',function(data){
  //   console.log('receiveTest',data);
  //   myNick = data.myNick;
  // })

</script>
</body>
</html>
